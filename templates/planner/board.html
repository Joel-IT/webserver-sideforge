{% extends "base.html" %}

{% block title %}{{ board.title }} - Planner{% endblock %}

{% block content %}
<div class="container planner-board">
    <h1>{{ board.title }}</h1>
    <p>{{ board.description }}</p>

    <div class="board-lists row">
        {% for list in board.lists %}
        <div class="col-md-4 list-column">
            <div class="card list-card">
                <div class="card-header">
                    <h3>{{ list.title }}</h3>
                    {% if current_user.id == board.owner_id or board_member_role in ['editor', 'admin'] %}
                    <button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#createTaskModal{{ list.id }}">
                        Add Task
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% for task in list.tasks %}
                    <div class="task-card {% if task.is_completed %}completed-task{% endif %} {% if task.priority == 'high' %}high-priority{% elif task.priority == 'low' %}low-priority{% endif %}">
                        <div class="task-header">
                            <h5>{{ task.title }}</h5>
                            <div class="task-actions">
                                {% if current_user.id == board.owner_id or board_member_role in ['editor', 'admin'] %}
                                <form action="{{ url_for('complete_task', task_id=task.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-sm {% if task.is_completed %}btn-success{% else %}btn-outline-success{% endif %}">
                                        {% if task.is_completed %}âœ“ Completed{% else %}Mark Complete{% endif %}
                                    </button>
                                </form>
                                <button class="btn btn-sm btn-outline-secondary" data-toggle="modal" data-target="#editTaskModal{{ task.id }}">
                                    Edit
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="task-details">
                            {% if task.description %}
                            <p>{{ task.description }}</p>
                            {% endif %}
                            <div class="task-meta">
                                {% if task.assigned_to %}
                                <span class="badge badge-info">Assigned to: {{ task.assigned_to.name }}</span>
                                {% endif %}
                                {% if task.due_date %}
                                <span class="badge badge-warning">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                                {% if task.completed_at %}
                                <span class="badge badge-success">Completed: {{ task.completed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Edit Task Modal -->
                    <div class="modal fade" id="editTaskModal{{ task.id }}" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Task</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <form action="{{ url_for('update_task', task_id=task.id) }}" method="POST">
                                    {{ form.csrf_token }}
                                    <div class="modal-body">
                                        <div class="form-group">
                                            {{ form.title.label }}
                                            {{ form.title(class="form-control", value=task.title) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.description.label }}
                                            {{ form.description(class="form-control") }}{{ task.description or '' }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.list_id.label }}
                                            {{ form.list_id(class="form-control") }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.assigned_to.label }}
                                            {{ form.assigned_to(class="form-control") }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.due_date.label }}
                                            {{ form.due_date(class="form-control", value=task.due_date.strftime('%Y-%m-%d') if task.due_date else '') }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.priority.label }}
                                            {{ form.priority(class="form-control", selected=task.priority) }}
                                        </div>
                                        <div class="form-group">
                                            {{ form.status.label }}
                                            {{ form.status(class="form-control", selected=task.status) }}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        {{ form.submit(class="btn btn-primary") }}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Create Task Modal -->
            <div class="modal fade" id="createTaskModal{{ list.id }}" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Create New Task</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form action="{{ url_for('create_task', board_id=board.id) }}" method="POST">
                            {{ form.csrf_token }}
                            <div class="modal-body">
                                <div class="form-group">
                                    {{ form.title.label }}
                                    {{ form.title(class="form-control") }}
                                </div>
                                <div class="form-group">
                                    {{ form.description.label }}
                                    {{ form.description(class="form-control") }}
                                </div>
                                <input type="hidden" name="list_id" value="{{ list.id }}">
                                <div class="form-group">
                                    {{ form.assigned_to.label }}
                                    {{ form.assigned_to(class="form-control") }}
                                </div>
                                <div class="form-group">
                                    {{ form.due_date.label }}
                                    {{ form.due_date(class="form-control") }}
                                </div>
                                <div class="form-group">
                                    {{ form.priority.label }}
                                    {{ form.priority(class="form-control") }}
                                </div>
                                <div class="form-group">
                                    {{ form.status.label }}
                                    {{ form.status(class="form-control") }}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.task-card {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.completed-task {
    background-color: #e9ecef;
    text-decoration: line-through;
}
.high-priority {
    border-left: 4px solid red;
}
.low-priority {
    border-left: 4px solid green;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var createTaskModal = document.getElementById('createTaskModal');
    createTaskModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var listId = button.getAttribute('data-list-id');
        var listSelect = createTaskModal.querySelector('#list_id');
        listSelect.value = listId;
    });
});
</script>
{% endblock %}
